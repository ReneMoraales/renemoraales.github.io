<style type="text/css">

html, body {
  overflow: hidden;
  height: 100vh;
}

body {
  margin: 0;
  height: 100%;
  overflow: hidden;
  width: 100%;
  position: fixed;
  background-color: black;
}

.wheel-container {
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background-image: url(https://i.kinja-img.com/gawker-media/image/upload/s--AMc4oDDD--/ugkj3lsrylr39sxpmw7u.jpg);
  background-size: cover;
  background-position: center;
}

.wheel {
  width: 530px;
  height: 530px;
  border-radius: 1000px;
  background-color: black;
  background-image: linear-gradient(135deg, #B22929 30%,#000 100%);
  background-position: center;
  background-size: 100% 100%;
  overflow: hidden;
}

.wheel .image {
  width: 100%;
  height: 100%;
  position: relative;
}

.wheel .image div {
  width: 100%;
  height: 100%;
  position: absolute;
  left: 0;
  top: 0;
  background-position: center;
  background-size: 112%;
  opacity: 0;
}

.wheel .image.blur0 .blur0 { opacity: 1; }
.wheel .image.blur1 .blur1 { opacity: 1; }
.wheel .image.blur2 .blur2 { opacity: 1; }
.wheel .image.blur3 .blur3 { opacity: 1; }
.wheel .image.blur4 .blur4 { opacity: 1; }
.wheel .image.blur5 .blur5 { opacity: 1; }
.wheel .image.blur6 .blur6 { opacity: 1; }
.wheel .image.blur7 .blur7 { opacity: 1; }
.wheel .image.blur8 .blur8 { opacity: 1; }
.wheel .image.blur9 .blur9 { opacity: 1; }
.wheel .image.blur10 .blur10 { opacity: 1; }

.wheel-screen {
  width: 100%;
  height: 100%;
  position: absolute;
  left: 0;
  top: 0;
  z-index: 20;
}

#needle {
  position: absolute;
  left: 50%;
  top: 50%;
  z-index: 20;
  width: 40px;
  margin-left: -20px;
  margin-top: -309px;
  transform-origin: 50% 15px;
  mix-blend-mode: luminosity;
}

#ring-fire {
  position: absolute;
  z-index: 10;
  mix-blend-mode: screen;
  width: 1370px;
  top: 50%;
  margin-top: -370px;
}

</style>

<img src="images/needle.png" id="needle">
<div class="wheel-container">
  <div class="wheel-screen" onclick="spin()"></div>
  <img id="ring-fire" src="https://media.giphy.com/media/JBruzzi53sb8Q/giphy.gif">
  <div class="wheel" style="transform: translate3D(0,0,0) rotate(0deg);">
    <!-- <img src="http://vignette1.wikia.nocookie.net/logopedia/images/8/89/New_Doritos_Logo.png/revision/latest?cb=20130305015621" class="logo"> -->
    <div id="wheel" class="image">
      <div style="background-image:url(images/doritron-blur0.png);" class="blur0"></div>
      <div style="background-image:url(images/doritron-blur1.png);" class="blur1"></div>
      <div style="background-image:url(images/doritron-blur2.png);" class="blur2"></div>
      <div style="background-image:url(images/doritron-blur3.png);" class="blur3"></div>
      <div style="background-image:url(images/doritron-blur4.png);" class="blur4"></div>
      <div style="background-image:url(images/doritron-blur5.png);" class="blur5"></div>
      <div style="background-image:url(images/doritron-blur6.png);" class="blur6"></div>
      <div style="background-image:url(images/doritron-blur7.png);" class="blur7"></div>
      <div style="background-image:url(images/doritron-blur8.png);" class="blur8"></div>
      <div style="background-image:url(images/doritron-blur9.png);" class="blur9"></div>
      <div style="background-image:url(images/doritron-blur10.png"); class="blur10"></div>
    </div>
  </div>
</div>

<script type="text/javascript" src="bower_components/lodash/dist/lodash.min.js"></script>
<script type="text/javascript" src="bower_components/chance/dist/chance.min.js"></script>
<script type="text/javascript" src="bower_components/animejs/anime.min.js"></script>
<script type="text/javascript" src="bower_components/howler.js/dist/howler.min.js"></script>
<script type="text/javascript" src="js/propeller.min.js"></script>
<script type="text/javascript">
  var readyToSpin = true;
  var lastNeedleAngle = 9999;
  var wheel = document.getElementById('wheel');
  var needle = document.getElementById('needle');

  var tick = new Howl({
    src: ['images/click.mp3']
  });

  var prizes = {
    set: {
      label: 'Set Doritos',
      ranges: [
        [30.06, 30.63],
        [31.84, 32.40],
        [34.24, 34.81]
      ]
    },
    tattoo: {
      label: 'Tatuaje',
      ranges: [
        [30.64, 31.21],
        [33.64, 34.21]
      ]
    },
    look: {
      label: 'Look Bold',
      ranges: [
        [31.24, 31.81],
        [33.04, 33.60],
        [34.84, 35.41]
      ]
    },
    now_or_never: {
      label: 'NOW OR NEVER',
      ranges: [
        [32.41, 33.00]
      ]
    }
  };

  var needleReturnAnimation = {
    pause: function() { }
  };

  function spin() {
    if ( !readyToSpin ) return;
    readyToSpin = false;

    var prize = prizes[chance.weighted(_.keys(prizes), [1800, 20, 180, 1])];
    var range = _.sample(prize.ranges);
    var speed = _.random(range[0], range[1], true);

    var lastWheelAngle = 0;

    new Propeller(wheel, {
      inertia: 0.99,
      speed: speed,
      onRotate: function() {
        updateNeedleRotation(this.angle);
        if ( this.speed < 0.02 ) {
          this.stop();
          onWheelStop();
        }
        console.log(this.speed);
        if ( this.speed < 10 ) {
          var blur = parseInt(this.speed);
          wheel.className = 'image blur'+blur;
        } else {
          wheel.className = 'image blur10';
        }
      },
      onStop: onWheelStop
    });

    function onWheelStop() {
      var needleAngle = getAngleFromElement(needle);
      if ( needleAngle < 360 ) {
        var wheelAngle = getAngleFromElement(wheel);
        var excess = ((360-needleAngle)/2.8);
        console.log(excess);
        anime({
          duration: 2000,
          targets: wheel,
          rotate: wheelAngle-excess-excess^1.1,
          easing: 'easeInOutQuart',
          update: function() {
            updateNeedleRotation(getAngleFromElement(wheel), true);
          }
        });
        // anime({
        //   duration: 1000,
        //   targets: needle,
        //   rotate: 360,
        //   easing: 'easeInOutQuad'
        // });
      }
      // alert('Ganaste '+prize.label+'!');
      readyToSpin = true;
    }
  }

  function updateNeedleRotation(angle, correction) {
    if ( correction ) {
      needleReturnAnimation.pause();
    }

    var correctedAngle = angle-27;
    if ( correctedAngle < 0 ) {
      correctedAngle = 360 + correctedAngle;
    }
    var modulus = (correctedAngle % 40);
    var needleAngle = modulus*2.8;
    if ( modulus > 16 ) {
      needleAngle = 0;
    }
    if ( needleAngle < lastNeedleAngle && !correction ) {
      tick.play();
    }

    if ( needleAngle == 0 && needleAngle < lastNeedleAngle ) {
      needleReturnAnimation = anime({
        targets: '#needle',
        rotate: 360,
        duration: 300,
        elasticity: 1000
      });
    } else if ( needleAngle > 0 ) {
      needle.style.transform = 'rotate('+(360-needleAngle)+'deg)';
    }

    lastNeedleAngle = needleAngle;
  }

  function getAngleFromElement(el) {
    var st = window.getComputedStyle(el, null);
    var tr = st.getPropertyValue("-webkit-transform") ||
             st.getPropertyValue("-moz-transform") ||
             st.getPropertyValue("-ms-transform") ||
             st.getPropertyValue("-o-transform") ||
             st.getPropertyValue("transform") ||
             "fail...";

    // rotation matrix - http://en.wikipedia.org/wiki/Rotation_matrix

    var values = tr.split('(')[1];
        values = values.split(')')[0];
        values = values.split(',');
    var a = values[0];
    var b = values[1];
    var c = values[2];
    var d = values[3];

    var scale = Math.sqrt(a*a + b*b);

    // arc sin, convert from radians to degrees, round
    // DO NOT USE: see update below
    var sin = b/scale;

    var angle = (Math.atan2(b, a) * (180/Math.PI));
    if ( angle < 0 ) {
      return 360 + angle;
    } else {
      return angle;
    }
  }

  spin();
</script>